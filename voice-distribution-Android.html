<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è¯­éŸ³é…è´§åŠ©æ‰‹</title>
  <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

      :root {
          --primary: #6366f1;
          --primary-dark: #4f46e5;
          --success: #10b981;
          --warning: #f59e0b;
          --danger: #ef4444;
          --bg-dark: #0f172a;
          --bg-card: #1e293b;
          --bg-card-light: #334155;
          --text-primary: #f1f5f9;
          --text-secondary: #94a3b8;
          --glow-primary: rgba(99, 102, 241, 0.5);
          --glow-success: rgba(16, 185, 129, 0.5);
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
          background: var(--bg-dark);
          min-height: 100vh;
          color: var(--text-primary);
          overflow-x: hidden;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          padding: 20px;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
      }

      .header {
          text-align: center;
          padding: 20px 0;
      }

      .header h1 {
          font-size: 24px;
          font-weight: 700;
          background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin-bottom: 4px;
      }

      .header p {
          font-size: 13px;
          color: var(--text-secondary);
      }

      .main-content {
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
      }

      /* Voice visualizer with volume bars */
      .voice-visualizer {
          width: 200px;
          height: 200px;
          margin: 0 auto 30px;
          position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .voice-ring {
          position: absolute;
          border-radius: 50%;
          border: 2px solid var(--primary);
          opacity: 0.3;
          animation: pulse 2s ease-in-out infinite;
      }

      .voice-ring:nth-child(1) {
          width: 100%;
          height: 100%;
          animation-delay: 0s;
      }

      .voice-ring:nth-child(2) {
          width: 80%;
          height: 80%;
          animation-delay: 0.3s;
      }

      .voice-ring:nth-child(3) {
          width: 60%;
          height: 60%;
          animation-delay: 0.6s;
      }

      @keyframes pulse {
          0%, 100% {
              transform: scale(1);
              opacity: 0.3;
          }
          50% {
              transform: scale(1.1);
              opacity: 0.6;
          }
      }

      .voice-icon {
          width: 90px;
          height: 90px;
          background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 40px;
          box-shadow: 0 0 40px var(--glow-primary);
          z-index: 1;
          transition: all 0.3s ease;
      }

      .listening .voice-ring {
          border-color: var(--success);
          animation: listening-pulse 0.5s ease-in-out infinite;
      }

      .listening .voice-icon {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          box-shadow: 0 0 40px var(--glow-success);
      }

      @keyframes listening-pulse {
          0%, 100% {
              transform: scale(1);
              opacity: 0.5;
          }
          50% {
              transform: scale(1.15);
              opacity: 0.8;
          }
      }

      /* Volume bars */
      .volume-bars {
          position: absolute;
          bottom: -40px;
          left: 50%;
          transform: translateX(-50%);
          display: flex;
          gap: 4px;
          height: 30px;
          align-items: flex-end;
      }

      .volume-bar {
          width: 4px;
          background: var(--success);
          border-radius: 2px;
          transition: height 0.1s ease;
          opacity: 0.6;
      }

      .product-info {
          background: var(--bg-card);
          border-radius: 16px;
          padding: 20px;
          margin-bottom: 20px;
          border: 1px solid var(--bg-card-light);
      }

      .product-name {
          font-size: 22px;
          font-weight: 700;
          text-align: center;
          margin-bottom: 16px;
          color: var(--text-primary);
      }

      .stats-row {
          display: flex;
          justify-content: space-around;
          margin-bottom: 16px;
      }

      .stat-item {
          text-align: center;
      }

      .stat-label {
          font-size: 12px;
          color: var(--text-secondary);
          margin-bottom: 4px;
      }

      .stat-value {
          font-size: 24px;
          font-weight: 700;
      }

      .stat-value.estimate { color: var(--primary); }
      .stat-value.remain { color: var(--warning); }
      .stat-value.need { color: var(--success); }

      .need-box {
          background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
          border: 2px solid var(--success);
          border-radius: 16px;
          padding: 16px;
          text-align: center;
      }

      .need-box .label {
          font-size: 13px;
          color: var(--success);
          margin-bottom: 4px;
      }

      .need-box .value {
          font-size: 42px;
          font-weight: 700;
          color: var(--success);
      }

      .need-box .unit {
          font-size: 16px;
          color: var(--success);
      }

      .progress-info {
          text-align: center;
          margin-bottom: 16px;
          font-size: 14px;
          color: var(--text-secondary);
      }

      .progress-bar {
          height: 6px;
          background: var(--bg-card-light);
          border-radius: 3px;
          overflow: hidden;
          margin-bottom: 20px;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary) 0%, #a855f7 100%);
          border-radius: 3px;
          transition: width 0.5s ease;
      }

      .status {
          text-align: center;
          padding: 12px;
          border-radius: 12px;
          font-size: 14px;
          margin-bottom: 20px;
      }

      .status.listening {
          background: rgba(16, 185, 129, 0.15);
          color: var(--success);
      }

      .status.speaking {
          background: rgba(99, 102, 241, 0.15);
          color: var(--primary);
      }

      .status.waiting {
          background: rgba(148, 163, 184, 0.15);
          color: var(--text-secondary);
      }

      .status.detecting {
          background: rgba(245, 158, 11, 0.15);
          color: var(--warning);
      }

      .user-speech {
          background: var(--bg-card-light);
          border-radius: 16px;
          padding: 16px;
          margin-bottom: 20px;
          min-height: 50px;
      }

      .user-speech .label {
          font-size: 12px;
          color: var(--text-secondary);
          margin-bottom: 6px;
      }

      .user-speech .text {
          font-size: 16px;
          color: var(--text-primary);
      }

      .hint {
          text-align: center;
          font-size: 13px;
          color: var(--text-secondary);
          padding: 12px;
          background: var(--bg-card);
          border-radius: 12px;
          margin-top: auto;
      }

      .hint strong {
          color: var(--success);
      }

      .page {
          display: none;
          flex-direction: column;
          flex: 1;
      }

      .page.active {
          display: flex;
      }

      .setup-card {
          background: var(--bg-card);
          border-radius: 20px;
          padding: 28px;
          border: 1px solid var(--bg-card-light);
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          font-size: 14px;
          color: var(--text-secondary);
          margin-bottom: 8px;
      }

      .form-group textarea {
          width: 100%;
          padding: 14px;
          background: var(--bg-dark);
          border: 2px solid var(--bg-card-light);
          border-radius: 12px;
          color: var(--text-primary);
          font-size: 14px;
          font-family: inherit;
          resize: vertical;
          min-height: 180px;
      }

      .form-group textarea:focus {
          outline: none;
          border-color: var(--primary);
      }

      .form-group textarea::placeholder {
          color: var(--text-secondary);
      }

      .help-text {
          font-size: 12px;
          color: var(--text-secondary);
          margin-top: 8px;
      }

      .btn {
          width: 100%;
          padding: 16px;
          border: none;
          border-radius: 14px;
          font-size: 16px;
          font-weight: 600;
          font-family: inherit;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .btn-primary {
          background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
          color: white;
          box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      }

      .btn-primary:active {
          transform: scale(0.98);
      }

      .complete-icon {
          width: 100px;
          height: 100px;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 20px;
          font-size: 50px;
          box-shadow: 0 0 40px var(--glow-success);
          animation: bounceIn 0.6s ease;
      }

      @keyframes bounceIn {
          0% { transform: scale(0); }
          50% { transform: scale(1.1); }
          100% { transform: scale(1); }
      }

      .complete-title {
          font-size: 24px;
          font-weight: 700;
          text-align: center;
          margin-bottom: 8px;
      }

      .complete-subtitle {
          font-size: 14px;
          color: var(--text-secondary);
          text-align: center;
          margin-bottom: 24px;
      }

      .total-box {
          background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
          border-radius: 16px;
          padding: 20px;
          text-align: center;
          margin-bottom: 20px;
      }

      .total-label {
          font-size: 14px;
          opacity: 0.9;
      }

      .total-value {
          font-size: 36px;
          font-weight: 700;
      }

      .summary-list {
          background: var(--bg-card);
          border-radius: 16px;
          padding: 16px;
          max-height: 250px;
          overflow-y: auto;
          margin-bottom: 20px;
      }

      .summary-item {
          display: flex;
          justify-content: space-between;
          padding: 10px 0;
          border-bottom: 1px solid var(--bg-card-light);
      }

      .summary-item:last-child {
          border-bottom: none;
      }

      .summary-item .name {
          color: var(--text-primary);
      }

      .summary-item .count {
          color: var(--success);
          font-weight: 600;
      }

      .summary-item .skipped {
          color: var(--text-secondary);
      }

      .system-info {
          background: rgba(99, 102, 241, 0.15);
          border: 1px solid var(--primary);
          border-radius: 12px;
          padding: 12px;
          margin-bottom: 16px;
          font-size: 12px;
          color: var(--text-secondary);
      }

      .info-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 4px;
      }

      .info-row:last-child {
          margin-bottom: 0;
      }

      .voice-commands {
          background: var(--bg-card);
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 20px;
      }

      .voice-commands h3 {
          font-size: 14px;
          color: var(--primary);
          margin-bottom: 12px;
      }

      .command-item {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 0;
          font-size: 13px;
          color: var(--text-secondary);
      }

      .command-item .icon {
          font-size: 16px;
      }

      @media (max-width: 400px) {
          .container {
              padding: 15px;
          }

          .voice-visualizer {
              width: 160px;
              height: 160px;
          }

          .voice-icon {
              width: 70px;
              height: 70px;
              font-size: 32px;
          }

          .need-box .value {
              font-size: 36px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ™ï¸ è¯­éŸ³é…è´§åŠ©æ‰‹</h1>
          <p>æ™ºèƒ½è¯­éŸ³è¯†åˆ«ï¼Œå®Œå…¨å…æ‰‹æ“ä½œ</p>
      </div>

      <!-- Setup Page -->
      <div id="setupPage" class="page active">
          <div class="main-content">
              <div class="setup-card">
                  <div id="systemInfo" class="system-info"></div>
                  
                  <div class="form-group">
                      <label>ğŸ“‹ ç²˜è´´é…è´§å•æ•°æ®</label>
                      <textarea id="dataInput" placeholder="æ ¼å¼ï¼šå•†å“åç§°,é¢„ä¼°æ•°é‡,å‰©ä½™æ•°é‡
ä¾‹å¦‚ï¼š
è‹¹æœ,100,20
é¦™è•‰,80,30
æ©™å­,50,10
ç‰›å¥¶,200,50
é¢åŒ…,60,15"></textarea>
                      <p class="help-text">æ¯è¡Œä¸€ä¸ªå•†å“ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”</p>
                  </div>

                  <div class="voice-commands">
                      <h3>ğŸ¤ è¯­éŸ³æŒ‡ä»¤è¯´æ˜</h3>
                      <div class="command-item">
                          <span class="icon">âœ…</span>
                          <span>è¯´"<strong>å®Œæˆ</strong>"ã€"<strong>ä¸‹ä¸€ä¸ª</strong>"ã€"<strong>å¥½äº†</strong>" â†’ å®Œæˆå½“å‰å•†å“</span>
                      </div>
                      <div class="command-item">
                          <span class="icon">â­ï¸</span>
                          <span>è¯´"<strong>è·³è¿‡</strong>"ã€"<strong>ä¸è¦</strong>" â†’ è·³è¿‡å½“å‰å•†å“</span>
                      </div>
                      <div class="command-item">
                          <span class="icon">ğŸ”</span>
                          <span>è¯´"<strong>é‡å¤</strong>"ã€"<strong>å†è¯´ä¸€é</strong>" â†’ é‡æ–°æ’­æŠ¥</span>
                      </div>
                  </div>

                  <button class="btn btn-primary" id="startBtn" ontouchstart="startVoiceDistribution()" onclick="startVoiceDistribution()">
                      ğŸš€ å¼€å§‹è¯­éŸ³é…è´§
                  </button>
              </div>
          </div>
      </div>

      <!-- Distribution Page -->
      <div id="distributionPage" class="page">
          <div class="progress-info">
              å•†å“ <span id="currentNum">1</span> / <span id="totalNum">10</span>
          </div>
          <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 10%"></div>
          </div>

          <div class="product-info">
              <div class="product-name" id="productName">å•†å“åç§°</div>
              <div class="stats-row">
                  <div class="stat-item">
                      <div class="stat-label">é¢„ä¼°é”€é‡</div>
                      <div class="stat-value estimate" id="estimateVal">100</div>
                  </div>
                  <div class="stat-item">
                      <div class="stat-label">å‰©ä½™æ•°é‡</div>
                      <div class="stat-value remain" id="remainVal">20</div>
                  </div>
              </div>
              <div class="need-box">
                  <div class="label">ğŸ¯ éœ€è¦é…é€</div>
                  <div>
                      <span class="value" id="needVal">80</span>
                      <span class="unit">ä»¶</span>
                  </div>
              </div>
          </div>

          <div class="voice-visualizer" id="voiceVisualizer">
              <div class="voice-ring"></div>
              <div class="voice-ring"></div>
              <div class="voice-ring"></div>
              <div class="voice-icon" id="voiceIcon">ğŸ™ï¸</div>
              <div class="volume-bars" id="volumeBars"></div>
          </div>

          <div class="status" id="statusIndicator">
              <span id="statusText">å‡†å¤‡ä¸­...</span>
          </div>

          <div class="user-speech">
              <div class="label">ğŸ‘¤ ä½ è¯´çš„è¯ï¼š</div>
              <div class="text" id="userSpeechText">ç­‰å¾…ä½ çš„è¯­éŸ³æŒ‡ä»¤...</div>
          </div>

          <div class="hint">
              ğŸ¤ <strong>ç›´æ¥è¯´è¯å³å¯</strong>ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«ä½ çš„è¯­éŸ³<br>
              ğŸ’¡ è¯´"å®Œæˆ"ç»§ç»­ä¸‹ä¸€ä¸ªï¼Œè¯´"è·³è¿‡"è·³è¿‡å½“å‰å•†å“
          </div>
      </div>

      <!-- Complete Page -->
      <div id="completePage" class="page">
          <div class="main-content">
              <div class="complete-icon">âœ“</div>
              <div class="complete-title">é…è´§å®Œæˆï¼</div>
              <div class="complete-subtitle">æ‰€æœ‰å•†å“å·²å¤„ç†å®Œæ¯•</div>

              <div class="total-box">
                  <div class="total-label">æœ¬æ¬¡é…é€æ€»é‡</div>
                  <div class="total-value" id="totalDelivery">0</div>
              </div>

              <div class="summary-list" id="summaryList"></div>

              <button class="btn btn-primary" ontouchstart="resetApp()" onclick="resetApp()">
                  ğŸ”„ å¼€å§‹æ–°çš„é…è´§
              </button>
          </div>
      </div>
  </div>

  <script>
      // Global variables
      let products = [];
      let currentIndex = 0;
      let completedProducts = [];
      let recognition = null;
      let synthesis = window.speechSynthesis;
      let isListening = false;
      let isSpeaking = false;
      let audioContext = null;
      let analyser = null;
      let microphone = null;
      let volumeCheckInterval = null;
      let recognitionTimeout = null;
      let lastRecognitionTime = 0;
      let isAndroid = /Android/i.test(navigator.userAgent);

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const VOLUME_THRESHOLD = 30; // éŸ³é‡é˜ˆå€¼
      const SILENCE_DELAY = 1500; // é™éŸ³åé‡å¯å»¶è¿Ÿ
      const MIN_RECOGNITION_INTERVAL = 1000; // æœ€å°è¯†åˆ«é—´éš”

      // Initialize system info
      function initSystemInfo() {
          const ua = navigator.userAgent;
          let browser = 'Unknown';
          
          if (ua.indexOf('Chrome') > -1 && ua.indexOf('Edg') === -1) browser = 'Chrome';
          else if (ua.indexOf('Safari') > -1 && ua.indexOf('Chrome') === -1) browser = 'Safari';
          else if (ua.indexOf('Edg') > -1) browser = 'Edge';
          else if (ua.indexOf('Firefox') > -1) browser = 'Firefox';

          const isSecure = location.protocol === 'https:';
          const hasRecognition = !!SpeechRecognition;
          const platform = isAndroid ? 'Android' : 'iOS/Other';

          const infoEl = document.getElementById('systemInfo');
          infoEl.innerHTML = `
              <div class="info-row">
                  <span>è®¾å¤‡å¹³å°ï¼š</span>
                  <span>${platform}</span>
              </div>
              <div class="info-row">
                  <span>æµè§ˆå™¨ï¼š</span>
                  <span>${browser}</span>
              </div>
              <div class="info-row">
                  <span>å®‰å…¨è¿æ¥ï¼š</span>
                  <span>${isSecure ? 'âœ“ HTTPS' : 'âœ— HTTP'}</span>
              </div>
              <div class="info-row">
                  <span>è¯­éŸ³è¯†åˆ«ï¼š</span>
                  <span>${hasRecognition ? 'âœ“ æ”¯æŒ' : 'âœ— ä¸æ”¯æŒ'}</span>
              </div>
          `;
      }

      // Create volume bars
      function createVolumeBars() {
          const container = document.getElementById('volumeBars');
          container.innerHTML = '';
          for (let i = 0; i < 12; i++) {
              const bar = document.createElement('div');
              bar.className = 'volume-bar';
              bar.style.height = '2px';
              container.appendChild(bar);
          }
      }

      // Update volume bars
      function updateVolumeBars(volume) {
          const bars = document.querySelectorAll('.volume-bar');
          const activeCount = Math.floor((volume / 100) * bars.length);
          
          bars.forEach((bar, index) => {
              if (index < activeCount) {
                  bar.style.height = `${Math.random() * 20 + 10}px`;
                  bar.style.opacity = '1';
              } else {
                  bar.style.height = '2px';
                  bar.style.opacity = '0.3';
              }
          });
      }

      // Initialize audio context for volume detection
      async function initAudioContext() {
          try {
              audioContext = new (window.AudioContext || window.webkitAudioContext)();
              analyser = audioContext.createAnalyser();
              analyser.fftSize = 256;
              analyser.smoothingTimeConstant = 0.8;

              const stream = await navigator.mediaDevices.getUserMedia({ 
                  audio: {
                      echoCancellation: true,
                      noiseSuppression: true,
                      autoGainControl: true
                  } 
              });
              
              microphone = audioContext.createMediaStreamSource(stream);
              microphone.connect(analyser);

              console.log('Audio context initialized successfully');
              return true;
          } catch (error) {
              console.error('Failed to initialize audio context:', error);
              return false;
          }
      }

      // Get current volume level
      function getVolumeLevel() {
          if (!analyser) return 0;

          const dataArray = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(dataArray);

          let sum = 0;
          for (let i = 0; i < dataArray.length; i++) {
              sum += dataArray[i];
          }
          
          return (sum / dataArray.length);
      }

      // Start volume monitoring
      function startVolumeMonitoring() {
          if (volumeCheckInterval) return;

          volumeCheckInterval = setInterval(() => {
              if (isSpeaking) return;

              const volume = getVolumeLevel();
              updateVolumeBars(volume);

              // Auto-start recognition when volume exceeds threshold
              if (volume > VOLUME_THRESHOLD && !isListening) {
                  const now = Date.now();
                  if (now - lastRecognitionTime > MIN_RECOGNITION_INTERVAL) {
                      console.log('Volume detected, starting recognition...');
                      startListening();
                  }
              }
          }, 100);
      }

      // Stop volume monitoring
      function stopVolumeMonitoring() {
          if (volumeCheckInterval) {
              clearInterval(volumeCheckInterval);
              volumeCheckInterval = null;
          }
      }

      // Parse input data
      function parseData(input) {
          const lines = input.trim().split('\n');
          const items = [];

          lines.forEach(line => {
              const parts = line.split(',').map(p => p.trim());
              if (parts.length >= 3) {
                  const name = parts[0];
                  const estimate = parseInt(parts[1]) || 0;
                  const remain = parseInt(parts[2]) || 0;

                  if (name) {
                      items.push({
                          name: name,
                          estimate: estimate,
                          remain: remain,
                          need: Math.max(0, estimate - remain)
                      });
                  }
              }
          });

          return items;
      }

      // Start voice distribution
      async function startVoiceDistribution() {
          const input = document.getElementById('dataInput').value;
          products = parseData(input);

          if (products.length === 0) {
              alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é…è´§å•æ•°æ®');
              return;
          }

          currentIndex = 0;
          completedProducts = [];

          showPage('distributionPage');
          createVolumeBars();

          // Initialize audio context
          const audioInitialized = await initAudioContext();
          
          if (!audioInitialized) {
              updateStatus('waiting', 'âš ï¸ æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
              return;
          }

          // Initialize speech recognition
          if (SpeechRecognition) {
              initSpeechRecognition();
          }

          // Start volume monitoring
          startVolumeMonitoring();

          // Show first product
          setTimeout(() => {
              showCurrentProduct();
          }, 500);
      }

      // Initialize speech recognition (optimized for Android)
      function initSpeechRecognition() {
          recognition = new SpeechRecognition();
          recognition.lang = 'zh-CN';
          recognition.continuous = false; // Non-continuous mode for better Android support
          recognition.interimResults = true;
          recognition.maxAlternatives = 1;

          recognition.onstart = () => {
              console.log('Recognition started');
              isListening = true;
              lastRecognitionTime = Date.now();
              updateStatus('listening', 'ğŸ¤ æ­£åœ¨å¬ä½ è¯´è¯...');
              document.getElementById('voiceVisualizer').classList.add('listening');
              document.getElementById('userSpeechText').textContent = 'æ­£åœ¨å¬...';
          };

          recognition.onend = () => {
              console.log('Recognition ended');
              isListening = false;
              document.getElementById('voiceVisualizer').classList.remove('listening');
              
              // Auto-restart after silence
              if (!isSpeaking && document.getElementById('distributionPage').classList.contains('active')) {
                  updateStatus('detecting', 'ğŸ”Š ç­‰å¾…ä½ è¯´è¯...');
                  // Don't auto-restart, let volume detection trigger it
              }
          };

          recognition.onresult = (event) => {
              let finalTranscript = '';
              let interimTranscript = '';

              for (let i = event.resultIndex; i < event.results.length; i++) {
                  const transcript = event.results[i][0].transcript;
                  if (event.results[i].isFinal) {
                      finalTranscript += transcript;
                  } else {
                      interimTranscript += transcript;
                  }
              }

              if (interimTranscript) {
                  document.getElementById('userSpeechText').textContent = interimTranscript + '...';
              }

              if (finalTranscript) {
                  console.log('Final transcript:', finalTranscript);
                  document.getElementById('userSpeechText').textContent = finalTranscript;
                  processVoiceCommand(finalTranscript);
              }
          };

          recognition.onerror = (event) => {
              console.error('Speech recognition error:', event.error);
              isListening = false;
              
              if (event.error === 'no-speech') {
                  // Normal, just wait for next speech
                  updateStatus('detecting', 'ğŸ”Š ç­‰å¾…ä½ è¯´è¯...');
              } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                  updateStatus('waiting', 'âš ï¸ éº¦å…‹é£æƒé™è¢«æ‹’ç»');
              } else if (event.error === 'network') {
                  updateStatus('waiting', 'âš ï¸ ç½‘ç»œé”™è¯¯');
              } else {
                  // Other errors, continue monitoring
                  updateStatus('detecting', 'ğŸ”Š ç­‰å¾…ä½ è¯´è¯...');
              }
          };
      }

      // Start listening
      function startListening() {
          if (!recognition || isListening || isSpeaking) return;

          try {
              recognition.start();
          } catch (e) {
              console.log('Recognition start error:', e);
          }
      }

      // Stop listening
      function stopListening() {
          if (recognition && isListening) {
              try {
                  recognition.stop();
              } catch (e) {
                  console.log('Recognition stop error:', e);
              }
          }
      }

      // Process voice command
      function processVoiceCommand(text) {
          const command = text.toLowerCase();

          if (command.includes('å®Œæˆ') || command.includes('ä¸‹ä¸€ä¸ª') || command.includes('å¥½äº†') || 
              command.includes('é…å¥½äº†') || command.includes('ä¸‹ä¸€') || command.includes('ç»§ç»­') ||
              command.includes('å¥½çš„') || command.includes('ç¡®å®š') || command.includes('æ˜¯çš„') ||
              command.includes('å¯ä»¥')) {
              completeCurrentProduct(false);
          } else if (command.includes('è·³è¿‡') || command.includes('ç•¥è¿‡') || command.includes('ä¸è¦') ||
                     command.includes('æ²¡æœ‰') || command.includes('ä¸é…')) {
              completeCurrentProduct(true);
          } else if (command.includes('é‡å¤') || command.includes('å†è¯´ä¸€é') || command.includes('ä»€ä¹ˆ') ||
                     command.includes('æ²¡å¬æ¸…') || command.includes('å†æ¥')) {
              repeatCurrentProduct();
          }
      }

      // Show current product
      function showCurrentProduct() {
          const product = products[currentIndex];

          document.getElementById('currentNum').textContent = currentIndex + 1;
          document.getElementById('totalNum').textContent = products.length;
          document.getElementById('progressFill').style.width = 
              ((currentIndex + 1) / products.length * 100) + '%';

          document.getElementById('productName').textContent = product.name;
          document.getElementById('estimateVal').textContent = product.estimate;
          document.getElementById('remainVal').textContent = product.remain;
          document.getElementById('needVal').textContent = product.need;

          speakProductInfo(product);
      }

      // Speak product info
      function speakProductInfo(product) {
          stopListening();
          isSpeaking = true;
          updateStatus('speaking', 'ğŸ”Š AIæ­£åœ¨æ’­æŠ¥...');

          synthesis.cancel();

          const text = `${product.name}ï¼Œé¢„ä¼°${product.estimate}ï¼Œå‰©ä½™${product.remain}ï¼Œéœ€è¦é…é€${product.need}ä»¶`;
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'zh-CN';
          utterance.rate = 1.0;
          utterance.pitch = 1.0;

          utterance.onend = () => {
              isSpeaking = false;
              updateStatus('detecting', 'ğŸ”Š ç­‰å¾…ä½ è¯´è¯...');
              document.getElementById('userSpeechText').textContent = 'è¯·è¯´å‡ºä½ çš„æŒ‡ä»¤...';
          };

          utterance.onerror = () => {
              isSpeaking = false;
              updateStatus('detecting', 'ğŸ”Š ç­‰å¾…ä½ è¯´è¯...');
          };

          synthesis.speak(utterance);
      }

      // Repeat current product
      function repeatCurrentProduct() {
          const product = products[currentIndex];
          speakProductInfo(product);
      }

      // Complete current product
      function completeCurrentProduct(skipped) {
          stopListening();
          
          const product = products[currentIndex];
          completedProducts.push({
              ...product,
              skipped: skipped
          });

          // Vibrate feedback (if supported)
          if (navigator.vibrate) {
              navigator.vibrate(skipped ? [100, 50, 100] : 200);
          }

          isSpeaking = true;
          synthesis.cancel();
          
          const confirmText = skipped ? 'å·²è·³è¿‡' : 'å¥½çš„ï¼Œå·²å®Œæˆ';
          const utterance = new SpeechSynthesisUtterance(confirmText);
          utterance.lang = 'zh-CN';
          utterance.rate = 1.2;

          utterance.onend = () => {
              isSpeaking = false;
              nextProduct();
          };

          utterance.onerror = () => {
              isSpeaking = false;
              nextProduct();
          };

          synthesis.speak(utterance);
      }

      // Next product
      function nextProduct() {
          currentIndex++;

          if (currentIndex >= products.length) {
              showComplete();
          } else {
              document.getElementById('userSpeechText').textContent = 'ç­‰å¾…ä½ çš„è¯­éŸ³æŒ‡ä»¤...';
              showCurrentProduct();
          }
      }

      // Show complete page
      function showComplete() {
          stopListening();
          stopVolumeMonitoring();
          
          if (microphone) {
              microphone.disconnect();
          }
          if (audioContext) {
              audioContext.close();
          }

          showPage('completePage');

          const total = completedProducts
              .filter(p => !p.skipped)
              .reduce((sum, p) => sum + p.need, 0);

          document.getElementById('totalDelivery').textContent = total;

          const summaryHtml = completedProducts.map(p => `
              <div class="summary-item">
                  <span class="name">${p.name}</span>
                  <span class="${p.skipped ? 'skipped' : 'count'}">
                      ${p.skipped ? 'å·²è·³è¿‡' : p.need + ' ä»¶'}
                  </span>
              </div>
          `).join('');

          document.getElementById('summaryList').innerHTML = summaryHtml;

          setTimeout(() => {
              const utterance = new SpeechSynthesisUtterance(`é…è´§å®Œæˆï¼æœ¬æ¬¡å…±é…é€${total}ä»¶å•†å“`);
              utterance.lang = 'zh-CN';
              synthesis.speak(utterance);
          }, 500);
      }

      // Update status indicator
      function updateStatus(type, text) {
          const indicator = document.getElementById('statusIndicator');
          const statusText = document.getElementById('statusText');
          
          indicator.className = 'status ' + type;
          statusText.textContent = text;
      }

      // Show page
      function showPage(pageId) {
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          document.getElementById(pageId).classList.add('active');
      }

      // Reset app
      function resetApp() {
          synthesis.cancel();
          stopListening();
          stopVolumeMonitoring();
          
          if (microphone) {
              microphone.disconnect();
              microphone = null;
          }
          if (audioContext) {
              audioContext.close();
              audioContext = null;
          }

          products = [];
          currentIndex = 0;
          completedProducts = [];
          document.getElementById('dataInput').value = '';
          document.getElementById('userSpeechText').textContent = 'ç­‰å¾…ä½ çš„è¯­éŸ³æŒ‡ä»¤...';
          showPage('setupPage');
      }

      // Cleanup on page unload
      window.onbeforeunload = () => {
          if (recognition) {
              recognition.stop();
          }
          synthesis.cancel();
          stopVolumeMonitoring();
          if (audioContext) {
              audioContext.close();
          }
      };

      // Initialize on load
      window.onload = () => {
          initSystemInfo();
      };
  </script>
</body>
</html>
