<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¯­éŸ³é…è´§åŠ©æ‰‹</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-light: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --glow-primary: rgba(99, 102, 241, 0.5);
            --glow-success: rgba(16, 185, 129, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Voice visualizer */
        .voice-visualizer {
            width: 160px;
            height: 160px;
            margin: 0 auto 30px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid var(--primary);
            opacity: 0.3;
            animation: pulse 2s ease-in-out infinite;
        }

        .voice-ring:nth-child(1) {
            width: 100%;
            height: 100%;
            animation-delay: 0s;
        }

        .voice-ring:nth-child(2) {
            width: 80%;
            height: 80%;
            animation-delay: 0.3s;
        }

        .voice-ring:nth-child(3) {
            width: 60%;
            height: 60%;
            animation-delay: 0.6s;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.6;
            }
        }

        .voice-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 0 40px var(--glow-primary);
            z-index: 1;
        }

        .listening .voice-ring {
            border-color: var(--success);
            animation: listening-pulse 0.5s ease-in-out infinite;
        }

        .listening .voice-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 40px var(--glow-success);
        }

        @keyframes listening-pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.8;
            }
        }

        /* Volume indicator */
        .volume-indicator {
            width: 100%;
            height: 8px;
            background: var(--bg-card-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
            width: 0%;
            transition: width 0.1s ease;
        }

        /* Product info card */
        .product-info {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--bg-card-light);
        }

        .product-name {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-value.estimate { color: var(--primary); }
        .stat-value.remain { color: var(--warning); }
        .stat-value.need { color: var(--success); }

        .need-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border: 2px solid var(--success);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }

        .need-box .label {
            font-size: 13px;
            color: var(--success);
            margin-bottom: 4px;
        }

        .need-box .value {
            font-size: 42px;
            font-weight: 700;
            color: var(--success);
        }

        .need-box .unit {
            font-size: 16px;
            color: var(--success);
        }

        /* Progress */
        .progress-info {
            text-align: center;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-card-light);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #a855f7 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Status indicator */
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .status.listening {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status.speaking {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
        }

        .status.waiting {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-secondary);
        }

        .status.volume-mode {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        /* User speech display */
        .user-speech {
            background: var(--bg-card-light);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            min-height: 50px;
        }

        .user-speech .label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .user-speech .text {
            font-size: 16px;
            color: var(--text-primary);
        }

        /* Hint */
        .hint {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            padding: 12px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-top: auto;
        }

        .hint strong {
            color: var(--success);
        }

        .hint.volume-mode-hint {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--warning);
            color: var(--text-primary);
        }

        /* Pages */
        .page {
            display: none;
            flex-direction: column;
            flex: 1;
        }

        .page.active {
            display: flex;
        }

        /* Setup page */
        .setup-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 28px;
            border: 1px solid var(--bg-card-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group textarea {
            width: 100%;
            padding: 14px;
            background: var(--bg-dark);
            border: 2px solid var(--bg-card-light);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 180px;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea::placeholder {
            color: var(--text-secondary);
        }

        .help-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Complete page */
        .complete-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 50px;
            box-shadow: 0 0 40px var(--glow-success);
            animation: bounceIn 0.6s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .complete-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
        }

        .complete-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 24px;
        }

        .total-box {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .total-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .total-value {
            font-size: 36px;
            font-weight: 700;
        }

        .summary-list {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--bg-card-light);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item .name {
            color: var(--text-primary);
        }

        .summary-item .count {
            color: var(--success);
            font-weight: 600;
        }

        .summary-item .skipped {
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 400px) {
            .container {
                padding: 15px;
            }

            .voice-visualizer {
                width: 140px;
                height: 140px;
            }

            .voice-icon {
                width: 70px;
                height: 70px;
                font-size: 32px;
            }

            .need-box .value {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ï¸ è¯­éŸ³é…è´§åŠ©æ‰‹</h1>
            <p>å…¨ç¨‹è¯­éŸ³äº¤äº’ï¼Œè§£æ”¾åŒæ‰‹</p>
        </div>

        <!-- Setup Page -->
        <div id="setupPage" class="page active">
            <div class="main-content">
                <div class="setup-card">
                    <div class="form-group">
                        <label>ğŸ“‹ ç²˜è´´é…è´§å•æ•°æ®</label>
                        <textarea id="dataInput" placeholder="æ ¼å¼ï¼šå•†å“åç§°,é¢„ä¼°æ•°é‡,å‰©ä½™æ•°é‡
ä¾‹å¦‚ï¼š
è‹¹æœ,100,20
é¦™è•‰,80,30
æ©™å­,50,10
ç‰›å¥¶,200,50
é¢åŒ…,60,15"></textarea>
                        <p class="help-text">æ¯è¡Œä¸€ä¸ªå•†å“ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”</p>
                    </div>
                    <button class="btn btn-primary" id="startBtn" onclick="startVoiceDistribution()">
                        ğŸš€ å¼€å§‹è¯­éŸ³é…è´§
                    </button>
                </div>
            </div>
        </div>

        <!-- Distribution Page -->
        <div id="distributionPage" class="page">
            <div class="progress-info">
                å•†å“ <span id="currentNum">1</span> / <span id="totalNum">10</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 10%"></div>
            </div>

            <div class="product-info">
                <div class="product-name" id="productName">å•†å“åç§°</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-label">é¢„ä¼°é”€é‡</div>
                        <div class="stat-value estimate" id="estimateVal">100</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å‰©ä½™æ•°é‡</div>
                        <div class="stat-value remain" id="remainVal">20</div>
                    </div>
                </div>
                <div class="need-box">
                    <div class="label">ğŸ¯ éœ€è¦é…é€</div>
                    <div>
                        <span class="value" id="needVal">80</span>
                        <span class="unit">ä»¶</span>
                    </div>
                </div>
            </div>

            <div class="voice-visualizer" id="voiceVisualizer">
                <div class="voice-ring"></div>
                <div class="voice-ring"></div>
                <div class="voice-ring"></div>
                <div class="voice-icon" id="voiceIcon">ğŸ™ï¸</div>
            </div>

            <div class="volume-indicator" id="volumeIndicator" style="display: none;">
                <div class="volume-bar" id="volumeBar"></div>
            </div>

            <div class="status" id="statusIndicator">
                <span id="statusText">å‡†å¤‡ä¸­...</span>
            </div>

            <div class="user-speech">
                <div class="label">ğŸ‘¤ ä½ è¯´çš„è¯ï¼š</div>
                <div class="text" id="userSpeechText">ç­‰å¾…ä½ çš„è¯­éŸ³æŒ‡ä»¤...</div>
            </div>

            <div class="hint" id="hintText">
                è¯´ <strong>"å®Œæˆ"</strong> æˆ– <strong>"ä¸‹ä¸€ä¸ª"</strong> ç»§ç»­<br>
                è¯´ <strong>"è·³è¿‡"</strong> è·³è¿‡å½“å‰å•†å“<br>
                è¯´ <strong>"é‡å¤"</strong> å†å¬ä¸€é
            </div>
        </div>

        <!-- Complete Page -->
        <div id="completePage" class="page">
            <div class="main-content">
                <div class="complete-icon">âœ“</div>
                <div class="complete-title">é…è´§å®Œæˆï¼</div>
                <div class="complete-subtitle">æ‰€æœ‰å•†å“å·²å¤„ç†å®Œæ¯•</div>

                <div class="total-box">
                    <div class="total-label">æœ¬æ¬¡é…é€æ€»é‡</div>
                    <div class="total-value" id="totalDelivery">0</div>
                </div>

                <div class="summary-list" id="summaryList"></div>

                <button class="btn btn-primary" onclick="resetApp()">
                    ğŸ”„ å¼€å§‹æ–°çš„é…è´§
                </button>
            </div>
        </div>
    </div>

    <script>
        // Data
        let products = [];
        let currentIndex = 0;
        let completedProducts = [];
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let isSpeaking = false;
        let volumeMode = false;
        let audioContext = null;
        let microphone = null;
        let analyser = null;
        let silenceTimer = null;
        let hasDetectedSound = false;

        // Check browser support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // Parse input data
        function parseData(input) {
            const lines = input.trim().split('\n');
            const items = [];

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 3) {
                    const name = parts[0];
                    const estimate = parseInt(parts[1]) || 0;
                    const remain = parseInt(parts[2]) || 0;

                    if (name) {
                        items.push({
                            name: name,
                            estimate: estimate,
                            remain: remain,
                            need: Math.max(0, estimate - remain)
                        });
                    }
                }
            });

            return items;
        }

        // Start voice distribution
        async function startVoiceDistribution() {
            const input = document.getElementById('dataInput').value;
            products = parseData(input);

            if (products.length === 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é…è´§å•æ•°æ®');
                return;
            }

            currentIndex = 0;
            completedProducts = [];

            showPage('distributionPage');

            // Try to initialize speech recognition first
            if (SpeechRecognition) {
                initSpeechRecognition();
            }

            // Also initialize volume detection as backup
            await initVolumeDetection();

            // Show first product
            setTimeout(() => {
                showCurrentProduct();
            }, 500);
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if (!SpeechRecognition) {
                switchToVolumeMode();
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;
            recognition.interimResults = true;

            let recognitionTimeout = null;

            recognition.onstart = () => {
                isListening = true;
                volumeMode = false;
                updateStatus('listening', 'ğŸ¤ æ­£åœ¨å¬ä½ è¯´è¯...');
                document.getElementById('voiceVisualizer').classList.add('listening');
                
                // Set a timeout to detect if recognition is actually working
                recognitionTimeout = setTimeout(() => {
                    console.log('Speech recognition seems inactive, switching to volume mode');
                    switchToVolumeMode();
                }, 5000);
            };

            recognition.onend = () => {
                isListening = false;
                document.getElementById('voiceVisualizer').classList.remove('listening');
                
                if (recognitionTimeout) {
                    clearTimeout(recognitionTimeout);
                }
                
                // Restart if not speaking and still on distribution page and not in volume mode
                if (!isSpeaking && !volumeMode && document.getElementById('distributionPage').classList.contains('active')) {
                    setTimeout(() => {
                        if (!isSpeaking && !volumeMode) {
                            startListening();
                        }
                    }, 300);
                }
            };

            recognition.onresult = (event) => {
                // Recognition is working! Clear the timeout
                if (recognitionTimeout) {
                    clearTimeout(recognitionTimeout);
                    recognitionTimeout = null;
                }

                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Show interim results
                if (interimTranscript) {
                    document.getElementById('userSpeechText').textContent = interimTranscript + '...';
                }

                // Process final results
                if (finalTranscript) {
                    document.getElementById('userSpeechText').textContent = finalTranscript;
                    processVoiceCommand(finalTranscript);
                }
            };

            recognition.onerror = (event) => {
                console.log('Speech recognition error:', event.error);
                
                if (event.error === 'network' || event.error === 'service-not-allowed' || event.error === 'no-speech') {
                    switchToVolumeMode();
                } else if (event.error === 'not-allowed') {
                    alert('è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£æƒé™');
                } else {
                    // For other errors, try to restart
                    setTimeout(() => {
                        if (!volumeMode) {
                            startListening();
                        }
                    }, 1000);
                }
            };

            startListening();
        }

        // Initialize volume detection
        async function initVolumeDetection() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                analyser.fftSize = 256;
                microphone.connect(analyser);
                
                console.log('Volume detection initialized');
                
                // Don't start monitoring yet, only if speech recognition fails
            } catch (err) {
                console.error('Failed to initialize volume detection:', err);
            }
        }

        // Switch to volume mode
        function switchToVolumeMode() {
            if (volumeMode) return; // Already in volume mode
            
            console.log('Switching to volume mode');
            volumeMode = true;
            
            // Stop speech recognition
            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (e) {}
            }
            
            // Update UI
            document.getElementById('volumeIndicator').style.display = 'block';
            document.getElementById('userSpeechText').textContent = 'éŸ³é‡æ£€æµ‹æ¨¡å¼';
            
            const hintEl = document.getElementById('hintText');
            hintEl.className = 'hint volume-mode-hint';
            hintEl.innerHTML = 'ğŸ”Š <strong>è¯´ä»»ä½•è¯ï¼ˆæˆ–æ‹æ‰‹ï¼‰</strong> å®Œæˆå½“å‰å•†å“<br>â° <strong>8ç§’ä¸è¯´è¯</strong> è‡ªåŠ¨è·³è¿‡';
            
            updateStatus('volume-mode', 'ğŸ”Š éŸ³é‡æ£€æµ‹æ¨¡å¼');
            
            // Start volume monitoring
            if (analyser) {
                startVolumeMonitoring();
            }
        }

        // Start volume monitoring
        function startVolumeMonitoring() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            hasDetectedSound = false;
            resetSilenceTimer();
            
            function checkVolume() {
                if (!volumeMode || !document.getElementById('distributionPage').classList.contains('active')) {
                    return;
                }
                
                analyser.getByteFrequencyData(dataArray);
                
                // Calculate average volume
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                
                // Update volume bar
                const volumePercent = Math.min(100, (average / 128) * 100);
                document.getElementById('volumeBar').style.width = volumePercent + '%';
                
                // Detect sound (threshold: 20)
                if (average > 20) {
                    onSoundDetected();
                }
                
                requestAnimationFrame(checkVolume);
            }
            
            checkVolume();
        }

        // On sound detected
        function onSoundDetected() {
            resetSilenceTimer();
            
            if (!hasDetectedSound && !isSpeaking) {
                hasDetectedSound = true;
                
                // Show feedback
                document.getElementById('userSpeechText').textContent = 'âœ“ æ£€æµ‹åˆ°å£°éŸ³';
                
                // Complete current product after a short delay
                setTimeout(() => {
                    if (hasDetectedSound) {
                        completeCurrentProduct(false);
                    }
                }, 800);
            }
        }

        // Reset silence timer
        function resetSilenceTimer() {
            if (silenceTimer) {
                clearTimeout(silenceTimer);
            }
            
            // Auto skip after 8 seconds of silence
            silenceTimer = setTimeout(() => {
                if (volumeMode && !isSpeaking && !hasDetectedSound) {
                    document.getElementById('userSpeechText').textContent = 'â° è¶…æ—¶è‡ªåŠ¨è·³è¿‡';
                    setTimeout(() => {
                        completeCurrentProduct(true);
                    }, 500);
                }
            }, 8000);
        }

        // Start listening
        function startListening() {
            if (recognition && !isListening && !isSpeaking && !volumeMode) {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Recognition start error:', e);
                }
            }
        }

        // Stop listening
        function stopListening() {
            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (e) {}
            }
        }

        // Process voice command
        function processVoiceCommand(text) {
            const command = text.toLowerCase();

            if (command.includes('å®Œæˆ') || command.includes('ä¸‹ä¸€ä¸ª') || command.includes('å¥½äº†') || 
                command.includes('é…å¥½äº†') || command.includes('ä¸‹ä¸€') || command.includes('ç»§ç»­')) {
                completeCurrentProduct(false);
            } else if (command.includes('è·³è¿‡') || command.includes('ç•¥è¿‡') || command.includes('ä¸è¦')) {
                completeCurrentProduct(true);
            } else if (command.includes('é‡å¤') || command.includes('å†è¯´ä¸€é') || command.includes('ä»€ä¹ˆ')) {
                repeatCurrentProduct();
            }
        }

        // Show current product
        function showCurrentProduct() {
            const product = products[currentIndex];

            // Update UI
            document.getElementById('currentNum').textContent = currentIndex + 1;
            document.getElementById('totalNum').textContent = products.length;
            document.getElementById('progressFill').style.width = 
                ((currentIndex + 1) / products.length * 100) + '%';

            document.getElementById('productName').textContent = product.name;
            document.getElementById('estimateVal').textContent = product.estimate;
            document.getElementById('remainVal').textContent = product.remain;
            document.getElementById('needVal').textContent = product.need;

            // Reset volume mode state
            hasDetectedSound = false;
            if (volumeMode) {
                resetSilenceTimer();
            }

            // Speak product info
            speakProductInfo(product);
        }

        // Speak product info
        function speakProductInfo(product) {
            stopListening();
            isSpeaking = true;
            updateStatus('speaking', 'ğŸ”Š AIæ­£åœ¨æ’­æŠ¥...');

            synthesis.cancel();

            const text = `${product.name}ï¼Œé¢„ä¼°${product.estimate}ï¼Œå‰©ä½™${product.remain}ï¼Œéœ€è¦é…é€${product.need}ä»¶`;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            utterance.onend = () => {
                isSpeaking = false;
                
                if (volumeMode) {
                    updateStatus('volume-mode', 'ğŸ”Š è¯·è¯´è¯æˆ–æ‹æ‰‹');
                    hasDetectedSound = false;
                    resetSilenceTimer();
                } else {
                    updateStatus('listening', 'ğŸ¤ è¯·è¯´"å®Œæˆ"ç»§ç»­ä¸‹ä¸€ä¸ª');
                    startListening();
                }
            };

            utterance.onerror = () => {
                isSpeaking = false;
                if (!volumeMode) {
                    startListening();
                }
            };

            synthesis.speak(utterance);
        }

        // Repeat current product
        function repeatCurrentProduct() {
            const product = products[currentIndex];
            speakProductInfo(product);
        }

        // Complete current product
        function completeCurrentProduct(skipped) {
            stopListening();
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
            }
            
            const product = products[currentIndex];
            completedProducts.push({
                ...product,
                skipped: skipped
            });

            // Speak confirmation
            isSpeaking = true;
            synthesis.cancel();
            
            const confirmText = skipped ? 'å·²è·³è¿‡' : 'å¥½çš„ï¼Œå·²å®Œæˆ';
            const utterance = new SpeechSynthesisUtterance(confirmText);
            utterance.lang = 'zh-CN';
            utterance.rate = 1.2;

            utterance.onend = () => {
                isSpeaking = false;
                nextProduct();
            };

            synthesis.speak(utterance);
        }

        // Next product
        function nextProduct() {
            currentIndex++;

            if (currentIndex >= products.length) {
                showComplete();
            } else {
                showCurrentProduct();
            }
        }

        // Show complete page
        function showComplete() {
            stopListening();
            volumeMode = false;
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
            }
            
            showPage('completePage');

            const total = completedProducts
                .filter(p => !p.skipped)
                .reduce((sum, p) => sum + p.need, 0);

            document.getElementById('totalDelivery').textContent = total;

            const summaryHtml = completedProducts.map(p => `
                <div class="summary-item">
                    <span class="name">${p.name}</span>
                    <span class="${p.skipped ? 'skipped' : 'count'}">
                        ${p.skipped ? 'å·²è·³è¿‡' : p.need + ' ä»¶'}
                    </span>
                </div>
            `).join('');

            document.getElementById('summaryList').innerHTML = summaryHtml;

            // Speak completion
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(`é…è´§å®Œæˆï¼æœ¬æ¬¡å…±é…é€${total}ä»¶å•†å“`);
                utterance.lang = 'zh-CN';
                synthesis.speak(utterance);
            }, 500);
        }

        // Update status indicator
        function updateStatus(type, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status ' + type;
            statusText.textContent = text;
        }

        // Show page
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // Reset app
        function resetApp() {
            synthesis.cancel();
            
            if (recognition && isListening) {
                stopListening();
            }
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
            }
            
            volumeMode = false;
            products = [];
            currentIndex = 0;
            completedProducts = [];
            
            document.getElementById('dataInput').value = '';
            document.getElementById('userSpeechText').textContent = 'ç­‰å¾…ä½ çš„è¯­éŸ³æŒ‡ä»¤...';
            document.getElementById('volumeIndicator').style.display = 'none';
            
            const hintEl = document.getElementById('hintText');
            hintEl.className = 'hint';
            hintEl.innerHTML = 'è¯´ <strong>"å®Œæˆ"</strong> æˆ– <strong>"ä¸‹ä¸€ä¸ª"</strong> ç»§ç»­<br>è¯´ <strong>"è·³è¿‡"</strong> è·³è¿‡å½“å‰å•†å“<br>è¯´ <strong>"é‡å¤"</strong> å†å¬ä¸€é';
            
            showPage('setupPage');
        }

        // Cleanup on page unload
        window.onbeforeunload = () => {
            if (recognition) {
                recognition.stop();
            }
            synthesis.cancel();
            if (audioContext) {
                audioContext.close();
            }
        };
    </script>
</body>
</html>
